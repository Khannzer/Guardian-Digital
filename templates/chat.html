<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!DOCTYPE html>
<html>

<head>
	<title>Agente Guardian Digital</title>


	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">

	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>


<body>
	<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
			<div class="modal-content shadow-lg">

				<div class="modal-header bg-dark text-white">
					<h5 class="modal-title">
						<i class="fas fa-file-contract"></i> T칠rminos y Condiciones
					</h5>
				</div>

				<div class="modal-body" style="max-height: 400px; overflow-y: auto;">

					<p>
						Bienvenido a Guardian Digital.
					</p>

					<p>
						1.-
						Guardi치n Digital es una herramienta de inteligencia artificial dise침ada para brindar contenci칩n
						emocional inicial bas치ndose en gu칤as cl칤nicas (mhGAP). No es un sustituto de diagn칩stico,
						terapia psicol칩gica ni atenci칩n m칠dica profesional.
						Guardi치n Digital est치 dise침ado exclusivamente para brindar orientaci칩n psicol칩gica general,
						apoyo emocional inicial y contenci칩n basada en gu칤as cl칤nicas reconocidas. El servicio no est치
						destinado a responder consultas m칠dicas especializadas, asesoramiento legal, diagn칩stico
						cl칤nico, prescripci칩n de tratamientos, ni resolver asuntos ajenos al 치mbito del bienestar
						emocional y la salud mental.
					</p>

					<p>
						2.-
						Si te encuentras en una situaci칩n de crisis severa, riesgo de autolesi칩n o suicidio, este chat
						no es el medio adecuado. Por favor, comun칤cate de inmediato a la *L칤nea 113 (Opci칩n 5) del
						MINSA, al 105 (Polic칤a), o acude a urgencias.
					</p>

					<p>
						3.-
						Tu uso de la plataforma es confidencial y an칩nimo. Los datos de la conversaci칩n se procesan
						temporalmente bajo la Ley N춿 29733 (Ley de Protecci칩n de Datos Personales del Per칰) con el 칰nico
						fin de generar respuestas, sin vincularlos a tu identidad.
					</p>

					<p>
						4.-
						Al interactuar con una Inteligencia Artificial, comprendes que las respuestas pueden presentar
						imprecisiones tecnol칩gicas. El equipo desarrollador no se hace responsable por las decisiones o
						acciones tomadas en base a la informaci칩n del chat.
					</p>

					<p>
						5.-
						El servicio puede presentar interrupciones t칠cnicas o mantenimiento sin previo aviso. No se
						garantiza disponibilidad continua o libre de errores.
					</p>

					<p>
						6.-
						Los t칠rminos y condiciones pueden actualizarse en cualquier momento. El uso continuado del
						servicio implica la aceptaci칩n de las modificaciones.
					</p>

					<p>
						En caso de emergencia, comun칤quese con los servicios de salud correspondientes.
						Guardi치n Digital no sustituye redes de apoyo humano. Se recomienda mantener contacto con
						familiares, amigos o profesionales de salud ante cualquier situaci칩n emocional dif칤cil.
					</p>

					<hr>

					<div class="form-check mt-3">
						<input type="checkbox" class="form-check-input" id="acceptCheck">
						<label class="form-check-label" for="acceptCheck">
							He le칤do y acepto los t칠rminos y condiciones
						</label>
					</div>

				</div>

				<div class="modal-footer">
					<button type="button" id="rejectBtn" class="btn btn-danger">
						Rechazar
					</button>

					<button type="button" id="acceptBtn" class="btn btn-success" disabled>
						Aceptar
					</button>
				</div>

			</div>
		</div>
	</div>
	<div class="modal fade" id="emergencyModal" tabindex="-1" role="dialog" data-backdrop="static"
		data-keyboard="false">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content border-danger shadow-lg" style="border-width: 3px;">

				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title">
						<i class="fas fa-exclamation-triangle"></i> 춰Importante! Tarjeta de Emergencia
					</h5>
					<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>

				<div class="modal-body text-center">
					<h4 class="text-danger mb-4">No est치s solo/a, queremos ayudarte.</h4>
					<p class="lead">Hemos detectado que podr칤as estar pasando por un momento muy dif칤cil.</p>
					<p>Por favor, considera hablar con un profesional inmediatamente:</p>

					<div class="alert alert-danger mt-4" role="alert">
						<h5><i class="fas fa-phone-alt"></i> L칤nea 113 (Opci칩n 5) - MINSA</h5>
						<p class="mb-0">Atenci칩n psicol칩gica gratuita las 24 horas.</p>
					</div>

					<div class="alert alert-dark" role="alert">
						<h5><i class="fas fa-phone-alt"></i> 105 - Polic칤a Nacional</h5>
						<p class="mb-0">En caso de una emergencia inmediata.</p>
					</div>
				</div>

				<div class="modal-footer justify-content-center">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Entendido, cerrar esta
						ventana</button>
				</div>

			</div>
		</div>
	</div>

	<div class="modal fade" id="recursosModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">

            <div class="modal-header bg-primary text-white" style="border-bottom: none;">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-hands-helping mr-2"></i> Centros de Salud Mental en <span id="ciudadTitulo" class="text-warning">...</span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">칑</span>
                </button>
            </div>

            <div class="modal-body p-0">
                <div class="row no-gutters">
                    <div class="col-lg-8" id="mapaContenedor" style="min-height: 500px; background: #e9ecef; display: flex; align-items: center; justify-content: center;">
                        <div class="text-center p-5">
                            <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="sr-only">Cargando...</span>
                            </div>
                            <h5 class="mt-3 text-muted">Buscando los centros m치s cercanos...</h5>
                            <p class="text-black-50 small">Conectando con Google Maps</p>
                        </div>
                    </div>

                    <div class="col-lg-4 bg-light p-4 d-flex flex-column">
                        <h5 class="text-dark border-bottom pb-2 mb-3">쮺칩mo usar este mapa?</h5>
                        
                        <ul class="list-unstyled text-muted mb-4">
                            <li class="mb-3"><i class="fas fa-map-pin text-danger mr-2"></i> Los pines rojos marcan los <strong>Centros de Salud Mental Comunitaria (CSMC)</strong> y hospitales.</li>
                            <li class="mb-3"><i class="fas fa-hand-pointer text-info mr-2"></i> Haz clic en cualquier pin para ver el <strong>horario y tel칠fono</strong>.</li>
                            <li class="mb-3"><i class="fas fa-walking text-success mr-2"></i> Usa el bot칩n de "Como llegar" en el mapa para saber c칩mo llegar.</li>
                        </ul>

                        <div class="mt-auto">
                            <a href="#" id="btnAbrirMaps" target="_blank" class="btn btn-primary btn-block shadow-sm mb-2">
                                <i class="fas fa-external-link-alt mr-1"></i> Abrir en la app de Maps
                            </a>
                            <div class="alert alert-warning small mb-0 p-2 text-center" role="alert">
                                <i class="fas fa-info-circle"></i> La atenci칩n en los CSMC del MINSA suele ser gratuita con SIS.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

	<div class="container-fluid h-100">
		<div class="row h-100">

			<!-- PANEL IZQUIERDO -->
			<div class="col-md-4 col-xl-3 border-right p-3" id="infoPanel">
				<h5 class="mb-3"><i class="fas fa-info-circle"></i> Informaci칩n</h5>
				<hr>

				<div id="chatInfo">
					<p><strong>Estado:</strong> Activo</p>
					<p><strong>Mensajes enviados:</strong> <span id="msgCount">0</span></p>
					<p><strong>Hora inicio:</strong> <span id="startTime"></span></p>
				</div>

				<hr>

				<button class="btn btn-outline-primary btn-sm btn-block" id="">
					Cambiar a tema
				</button>

				<button class="btn btn-outline-danger btn-sm btn-block" id="clearChat">
					Limpiar conversaci칩n
				</button>
				<br>
				<p><strong>Recursos de ayuda:</strong> <span id="startTime"></span></p>
				<button class="btn btn-outline-info btn-sm btn-block mt-3" data-toggle="modal"
					data-target="#recursosModal">
					<i class="fas fa-map-marker-alt"></i> Centros de Ayuda Cercanos
				</button>
				<a href="/botiquin" class="btn btn-outline-success btn-sm btn-block mt-3 shadow-sm">
                    <i class="fas fa-leaf"></i> Mi Botiqu칤n
                </a>
				<br>
				<a href="/logout" class="btn btn-danger btn-sm btn-block mt-auto shadow-sm">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
                </a>

			</div>

			<!-- CHAT (DERECHA) -->
			<div class="col-md-8 col-xl-9 chat">
				<div class="card">
					<div class="card-header msg_head">
						<div class="d-flex bd-highlight">
							<div class="img_cont">
								<img src="https://cdn-icons-png.flaticon.com/512/9439/9439123.png"
									class="rounded-circle user_img">
								<span class="online_icon"></span>
							</div>
							<div class="user_info">
								<span>Tu asistente virtual</span>
								<p>쮼n que te puedo ayudar el d칤a de hoy?</p>
							</div>
						</div>
					</div>
					<div id="messageFormeight" class="card-body msg_card_body">


					</div>
					<div class="card-footer">
						<form id="messageArea" class="input-group">
							<input type="text" id="text" name="msg" placeholder="..." autocomplete="off"
								class="form-control type_msg" required />
							<div class="input-group-append">
								<button type="submit" id="send" class="input-group-text send_btn"><i
										class="fas fa-location-arrow"></i></button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		$(document).ready(function () {

			// Jinja2 inyectar치 el nombre real del usuario logueado aqu칤
			const nombreUsuario = "{{ usuario.nombre }}";

			// Obtenemos la hora actual para ponerla en la burbuja
			const dateWelcome = new Date();
			const hourWelcome = dateWelcome.getHours();
			const minuteWelcome = dateWelcome.getMinutes() < 10 ? '0' + dateWelcome.getMinutes() : dateWelcome.getMinutes();
			const str_timeWelcome = hourWelcome + ":" + minuteWelcome;

			// Redactamos el mensaje de contenci칩n inicial
			const mensajeBienvenida = `춰Hola, <b>${nombreUsuario}</b>! 游녦 Soy Guardi치n Digital. Este es un espacio seguro y confidencial, libre de juicios, solo para ti. Estoy aqu칤 para escucharte, sin importar lo que te preocupe o si solo quieres desahogarte. 쮺칩mo te sientes el d칤a de hoy?`;

			// Armamos el HTML 
			var botWelcomeHtml = '<div class="d-flex justify-content-start mb-4"><div class="img_cont_msg"><img src="https://cdn-icons-png.flaticon.com/512/9439/9439123.png" class="rounded-circle user_img_msg"></div><div class="msg_cotainer">' + mensajeBienvenida + '<span class="msg_time">' + str_timeWelcome + '</span></div></div>';

			// Lo mostramos en la pantalla del chat autom치ticamente
			$("#messageFormeight").append(botWelcomeHtml);

			// Logica para los mensajes enviados por el usuario
			$("#messageArea").on("submit", function (event) {
				const date = new Date();
				const hour = date.getHours();
				const minute = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
				const str_time = hour + ":" + minute;
				var rawText = $("#text").val();

				var userHtml = '<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">' + rawText + '<span class="msg_time_send">' + str_time + '</span></div><div class="img_cont_msg"><img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg"></div></div>';

				$("#text").val("");
				$("#messageFormeight").append(userHtml);

				// Hacemos scroll hacia abajo cuando el usuario env칤a
				$("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);

				$.ajax({
					data: { msg: rawText },
					type: "POST",
					url: "/get",
				}).done(function (data) {
					// Extraemos SOLO el texto de la respuesta
					var textoBot = data.answer;

					var botHtml = '<div class="d-flex justify-content-start mb-4"><div class="img_cont_msg"><img src="https://cdn-icons-png.flaticon.com/512/9439/9439123.png" class="rounded-circle user_img_msg"></div><div class="msg_cotainer">' + textoBot + '<span class="msg_time">' + str_time + '</span></div></div>';

					$("#messageFormeight").append($.parseHTML(botHtml));

					// Hacer scroll autom치tico hacia abajo al recibir respuesta
					$("#messageFormeight").scrollTop($("#messageFormeight")[0].scrollHeight);

					// L칍GICA DE LA TARJETA DE EMERGENCIA
					if (data.riesgo_inminente === true) {
						$('#emergencyModal').modal('show');
					}
				});
				event.preventDefault();
			});

		});


		$(document).ready(function () {

            // 1. PRIMERO REVISAMOS LA MEMORIA
            // Si NO es igual a "true", significa que no ha aceptado a칰n
            if (localStorage.getItem("termsAccepted") !== "true") {
                
                // Inicializamos y mostramos el modal
                $('#termsModal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $('#termsModal').modal('show');
            }

            // 2. Habilitar bot칩n aceptar solo si marca el checkbox
            $('#acceptCheck').change(function () {
                if ($(this).is(':checked')) {
                    $('#acceptBtn').prop('disabled', false);
                } else {
                    $('#acceptBtn').prop('disabled', true);
                }
            });

            // 3. Acci칩n al hacer clic en ACEPTAR
            $('#acceptBtn').click(function () {
                // GUARDAMOS EL RECORDATORIO EN EL NAVEGADOR
                localStorage.setItem("termsAccepted", "true");
                $('#termsModal').modal('hide');
            });

            // 4. Acci칩n al hacer clic en RECHAZAR
            $('#rejectBtn').click(function () {
                $("#messageArea :input").prop("disabled", true);
                alert("Debes aceptar los t칠rminos para usar el chatbot.");
            });

        });

		//Limpiar conversaci칩n

		$("#clearChat").click(function () {

			// Guardar el primer mensaje (bienvenida)
			var mensajePrincipal = $("#messageFormeight").children().first().prop('outerHTML');

			// Vaciar todos los mensajes
			$("#messageFormeight").empty();

			// Volver a insertar el mensaje principal
			$("#messageFormeight").append(mensajePrincipal);

			// Reiniciar contador
			messageCount = 0;
			$("#msgCount").text("0");

        });

		$(document).ready(function () {
            // 1. DATOS REALES DE LA BASE DE DATOS
            let departamentoDB = "{{ usuario.departamento }}";
            let provinciaDB = "{{ usuario.provincia }}";
            let distritoDB = "{{ usuario.distrito }}";

            // Guardamos el HTML original de carga para reutilizarlo
            const loaderHTML = `
                <div class="text-center p-5">
                    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="sr-only">Cargando...</span>
                    </div>
                    <h5 class="mt-3 text-muted">Buscando los centros m치s cercanos...</h5>
                    <p class="text-black-50 small">Conectando con Google Maps</p>
                </div>
            `;

            $('#recursosModal').on('show.bs.modal', function () {
                // Actualizamos el t칤tulo
                $('#ciudadTitulo').text(distritoDB + ", " + provinciaDB);

                // Concatenaci칩n exacta
                let ubicacionExacta = distritoDB + ", " + provinciaDB + ", " + departamentoDB;
                let terminoBusqueda = "centros de salud mental comunitaria en " + ubicacionExacta;

                // URL para el Iframe (Embed)
                let urlMapaEmbed = "https://maps.google.com/maps?q=" + encodeURIComponent(terminoBusqueda) + "&t=&z=14&ie=UTF8&iwloc=&output=embed";
                
                // URL para el bot칩n "Abrir en la app" (Redirecci칩n directa a Google Maps)
                let urlMapaDirecto = "https://www.google.com/maps/search/" + encodeURIComponent(terminoBusqueda);

                // Actualizamos el enlace del bot칩n lateral
                $('#btnAbrirMaps').attr('href', urlMapaDirecto);

                let iframeMapa = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        style="border:0; min-height: 500px;" 
                        src="${urlMapaEmbed}" 
                        allowfullscreen>
                    </iframe>
                `;

                // Simulamos un tiempo de carga suave
                setTimeout(function () {
                    $('#mapaContenedor').html(iframeMapa);
                }, 1000);
            });

            // Limpiamos y restauramos el loader al cerrar
            $('#recursosModal').on('hidden.bs.modal', function () {
                $('#mapaContenedor').html(loaderHTML);
            });
        });
	</script>

</body>

</html>